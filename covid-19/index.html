<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://static.rappler.com/cache/assets/1557569470-2d523a8530817b46443618220132ae19.css" type="text/css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script>
        <style>
            html, body {
                margin: 0;
            }
            #map {
                width: 100vw;
                height: 600;
            }
            h1, p {
                margin: 30px;
            }
            .leaflet-info, .leaflet-popup-content-wrapper {
                width: 150px;
                background: rgba(255,255,255,0.8);
                padding: 5px;
                border-radius: 5px;
            }
            .leaflet-popup-content {
                margin: 0;
                line-height: 1.2;
            }
            .leaflet-popup-tip {
                background: rgba(255,255,255,0.8);
            }
            
        </style>
    </head>
    <body>
        <div>
            <h1 class="select-headline">Covid-19 cases map</h1>
        </div>
        
        <div id='map'>
        </div>
        <script>
            
            var currentScale = 2.5;

            if(document.documentElement.clientWidth < 768) {
                var initialCenter = {
                    center: [14.585211804919707,121.03214996983299],
                    zoom: 10
                };
            } else {
                var initialCenter = {
                    center: [14.4724735,121.0511779],
                    zoom: 10
                };
            }


            var map = L.map('map',{
                boxZoom: false,
                scrollWheelZoom: false,
                zoomSnap: 0.5,
                zoomDelta: 0.5
                }).setView(initialCenter['center'], initialCenter['zoom']);
            
            var mainTile = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                minZoom: 5,
                maxZoom: 19,
            }).addTo(map);

            L.TopoJSON = L.GeoJSON.extend({
                addData: function (data) {
                var geojson, key;
                if (data.type === "Topology") {
                    for (key in data.objects) {
                    if (data.objects.hasOwnProperty(key)) {
                        geojson = topojson.feature(data, data.objects[key]);
                        L.GeoJSON.prototype.addData.call(this, geojson);
                    }
                    }
                    return this;
                }
                L.GeoJSON.prototype.addData.call(this, data);
                return this;
                }
            });
            L.topoJson = function (data, options) {
                return new L.TopoJSON(data, options);
            };
            //create an empty geojson layer
            //with a style and a popup on click
            var geojson = L.topoJson(null, {
                style: function(feature){
                return {
                    color: "#000",
                    opacity: 1,
                    weight: 1,
                    fillColor: feature.properties.fillColor,
                    fillOpacity: 0.4
                }
                },
                onEachFeature: function(feature, layer) {
                    if (feature.properties.NAME_1 !== 'Laguna Lake') {
                        layer.bindPopup('<b>'+((feature.properties.NAME_1 === 'Metropolitan Manila') ? feature.properties.NAME_2 : feature.properties.NAME_1)+'</b><br />' + feature.properties.case_count + ' confirmed' + ((feature.properties.case_count != 1)? ' cases': ' case'));
                    }                    
                }
            });
            
            //define a function to get and parse geojson from URL
            async function getGeoData(url) {
                let response = await fetch(url);
                let data = await response.json();
                console.log(data)
                return data;
            }

            
            

            d3.csv('data/covid-19 locations 20200317.csv').then(function(raw_data) {
                // create scaling
                var caseArray = raw_data.map(function(d){return parseInt(d['case_count'])})    
                var radiusScale = d3.scaleLinear().domain([Math.min(...caseArray), Math.max(...caseArray)]).range([2.5,10])
                var colorScale = d3.scaleLinear().domain([Math.min(...caseArray), Math.max(...caseArray)]).range(['white', 'red']);

                var layerGroups = ['health_facility', 'residence'].map(function(location_filter) {
                    // filter for health_facility or residence data only
                    data = raw_data.filter(function(d) {
                        return (d['location_type']==location_filter && d['case_count'] > 0);
                    });

                    var circles = data.map(function(d) {
                        var circle = L.circleMarker([d['lat'],d['long']], {
                            color: 'red',
                            fillColor: '#f03',
                            fillOpacity: 0.25,
                            radius: radiusScale(d['case_count'])*currentScale
                        });
                        circle.bindPopup(
                            '<b>' + d['location_name'] + '</b><br />' + d['case_count'] + ((d['case_count'] > 1) ? ' cases' : ' case')
                        )
                        circle.on('mouseover', function(e) {
                            this.openPopup();
                            
                        });
                        circle.on('mouseout', function(e) {
                            this.closePopup();
                        });            
                        return circle;
                    });
                    var circlesLayerGroup = L.layerGroup(circles);
                    
                    if (location_filter=='health_facility') {
                        circlesLayerGroup.addTo(map);
                    }

                    return(circlesLayerGroup);
                });

                getGeoData('data/philippines-topo2.json').then(topodata => {
                    topodata.objects.philippines.geometries.forEach(function(province) {
                        
                        var provinceFilter = (province.properties.NAME_1 === 'Metropolitan Manila') ? province.properties.NAME_2 : province.properties.NAME_1;
                        var provinceCases = raw_data.filter(function(e) {
                            return (e.location_type == 'residence_province' && provinceFilter == e.location_name)
                        });
                        if(provinceCases.length ==  1) {
                            province.properties.case_count = provinceCases[0]['case_count'];
                            province.properties.fillColor = colorScale(provinceCases[0]['case_count']);
                        } else {
                            province.properties.case_count = 0;
                        }     
                    })
                    geojson.addData(topodata);
                });
                L.control.layers(null, 
                    {'Health facilities':layerGroups[0], 'By residence':layerGroups[1], 'By province':geojson},
                    {collapsed:true}).addTo(map);


            });

            


        
        </script>


    </body>
    
</html>